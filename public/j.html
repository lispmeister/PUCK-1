<!DOCTYPE html>
<html lang="en">
  <head>

<!-- A special thanks to the fine folks who did:

    jquery
    bootstrap & glyphicons
    node.js

    And all the billions of libs and lines of code that I built
    this all on (I tried to cite everyone, let me know if I missed
    anything!)

-->


<meta charset="utf-8">
<title>PUCKasaurus Rex!</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="rawr!">

<!-- Le styles -->
<!-- <link href="/css/bootstrap.min.css" rel="stylesheet"> -->

<!-- made a one line change in this, noted at top -->
<link href="/css/bootstrap.css" rel="stylesheet">

<!-- for calls -->
<link href="/css/avgrund.css" rel="stylesheet">

<!-- trivial bits here -->
<link href="/css/puck.css" rel="stylesheet">

<!-- form to add files -->
<link href="/css/jquery.filer.css" rel="stylesheet">

<!-- a few more icons -->
<link href="/css/whhg.css" rel="stylesheet">

<!-- nav menus -->
<link href="/css/yamm.css" rel="stylesheet">

<!-- <link href="/css/bootstrap-responsive.css" rel="stylesheet"> -->

<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
  <script src="/js/html5shiv.js"></script>
<![endif]-->

<!-- for pucks -->
<!-- http://cube3x.com/adipoli-jquery-image-hover-plugin/ -->
<!-- <link href="/css/adipoli.css" rel="stylesheet" type="text/css"/> -->


</head>

<body>

    <div class="container">

        <nav class="navbar navbar-default zenlarge" role="navigation">

            <ul class="nav nav-tabs navbar-nav navbar-left">

                <li class="active"><a href="#home" data-toggle="tab"><span id="puck_top_home" title="home" data-content="Click your heels three times..." class="glyphicon glyphicon-home"></span></a></li>

                <!-- need to find/make a good sheep icon! -->
                <!-- <li> <a href="#profile" data-toggle="tab"><img style="margin-top:20px" id="puck_top_ewe" title="Enough about me, let's talk about Ewe!" src="images/sheep.png"></a></li> -->

                <li> <a href="#ewe" data-toggle="tab"><span id="puck_top_ewe" title="You!" data-content="Enough about me, let's talk about Ewe!" class="glyphicon glyphicon-user"></span></a></li>

                <li class="dropdown">

                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id="puck_top_love" title="Love -n- Trust" data-content="Loves, friends, enemies, PUCKs...." class="glyphicon glyphicon-heart"></span><b class="caret"></b></a>

                    <ul class="dropdown-menu">
                        
                        <li> <a tabindex="-1" data-toggle="tab" href="#puck_trust_generate"> Generate Authentication Tokens</a> </li>
                        <li> <a tabindex="-1" data-toggle="tab" href="#puck_trust_explore"> Creating and seeing who you trust</a> </li>
                        <li> <a tabindex="-1" data-toggle="tab" href="#puck_trust_you"> Who trusts your PUCK?</a> </li>

                    </ul>
                </li>

                <li> <a href="#puck_cloud" data-toggle="tab"><span id="puck_top_cloud" title="File Vault" data-content="Files-n-secret stuffz" class="glyphicon glyphicon-cloud"></span></a></li>

                <li> <a href="#messages" data-toggle="tab"><span id="puck_top_messages" title="Messages" data-content="Message center: notes, files, and events" class="glyphicon glyphicon-envelope"></span></a></li>
    
                <li> <a href="#puck_vpn" data-toggle="tab"><span id="puck_video" title="VPN" data-content="All the cool stuff - calls, chat, etc" class="glyphicon glyphicon-facetime-video"></span></a></li>

                </ul>

            <ul class="nav nav-tabs navbar-nav navbar-right">

                <li> <a href="#"><span class="green glyphicon icon-lightbulb-idea" id="puck_status"></span></a></li>

                <li> <a href="#"><span data-content="help, videos, etc. here..." class="glyphicon icon-question-sign" id="puck_help"></span></a></li>

                <li> <a href="#skull" data-toggle="tab"><span id="puck_top_skull" title="PANIC!" data-content="Aieee!  Ack!  No!  PANIC TIME!!!!!" class="glyphicon icon-skull"></span></a></li>


                <li> <a target="_blank" href="https://github.com/zenfish/PUCK"><span id="puck_git" title="github sources" data-content="Github, sources 'n' secretz here" class="glyphicon icon-github"></span></a></li>

            </ul>

        </nav>


        <div class="container-fluid">

            <!-- for incoming/outgoing calls -->

            <a href="#" id="incoming" class="button left"></a>
            <a href="#" id="outgoing" class="button left"></a>

            <form id="modalPuck" class="modal fade form-horizontal" tabindex="-1" role="diaglog" aria-labelledby="modalPuckLabel" aria-hidden="true" action='/form' method="POST">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                            <h3 id="modalPuckLabel">Add PUCK</h3>
                        </div>
                        <div class="modal-body">
                            <fieldset>
                            <div class="control-group">
                                <label class="control-label" for="ip_addr">IP Address</label>
                                <div class="controls">
                                    <input type="text" id="ip_addr" name="ip_addr" placeholder="" maxlength="21" class="input-xlarge">
                                    <p class="help-block"></p>
                                </div>
                            </div>
                            <span> 
                                <input style="display:none" id="puck_action" name="puck_action" value="CREATE" />
                            </span>

                            <div class="control-group">
                                <div class="controls">
                                <!-- this does some javascript fu below to post the data and redirect back to this page -->
                                <button id="puck_button_create" class="btn btn-success">Create</button>
                                </div>
                            </div>

                            </fieldset>
                        </div>

                    </div>
                </div>
            </form>

        </div> <!-- end of form/top stuff -->


        <div class="container-fluid tab-content">

        <!-- pucks -->
            <div class="tab-pane fade in active" id="home">
    
                <div class="row-fluid marketing" id="puck_friends">
                    <div class="muted">
                        <h3>Friends <a href="#modalPuck" role="button" class="btn btn-success btn-xs" data-toggle="modal"><span class="glyphicon glyphicon-plus"></span></a></h3>
                    </div>
        
                    <!-- spinner when loading pucks -->
                    <div id="puck_loading" class="spinner">
                        <div class="double-bounce1"></div>
                        <div class="double-bounce2"></div>
                    </div>
    
                </div>
    
            </div>
    
            <!-- profile -->
            <div class="tab-pane fade" id="skull">
                <div class="row-fluid marketing" id="puck_panic_area">

                    <div class="muted">
                        <h3 style="clear:both">&iexcl;PANIC!</h3>
                    </div>

                    <div>
                        <p> Pushing these buttons is not for the faint of heart.
                        <ul>
                            <p> <li><strong>PANIC</strong> will crush your PUCK into uselessness.  Good if people are hammering at your door wanting its data or keys.  UI will no longer work.</li>
                            <p> <li><strong>Stop server</strong> stops the PUCK server dead.  UI will no longer work until restarted!</li>
                            <p> <li><strong>Restart server</strong> does just that - the PUCK server restarts.  UI will no longer work until it finishes restarting.</li>
                            <p> <li><strong>Stop VPN client</strong> kills any VPN clients

                        </ul>
                    </div>

                    <p>
                    <div>
                        <button id="puck_panic" type="button" class="btn btn-danger">PANIC</button>
                        <button id="stop_server" type="button" class="btn">Stop Server</button>
                        <button id="restart_server" type="button" class="btn btn-warning">Restart Server</button>
                        <button id="halt_vpn_client" type="button" class="btn btn-primary">Die VPN, Die!</button>
                    </div>
                </div>
            </div>

            <!-- profile -->
            <div class="tab-pane fade" id="ewe">

                <div class="container"> <div class="row">
                    <div class="col-xs-4">
                            <h3 style="clear:both">profilasaurus</h3>
                            Enough about you, what about me?<p>
                            Details about your PUCK and possibly you, if you wish.<p>
                            You'll be able to change your picture here, etc., etc.<p>
                    </div>
                    <div class="col-xs-2"> </div>

                    <div class="col-xs-4">
                        <h3>Browser WebRTC Health</h3>
                        <table id="puck_rtc_health_check" class="table table-condensed table-hover table-striped">
                        <tr> <th> Feature </th> <th> Support? </th> <th> Feature </th> <th> Support? </th> </tr>
                        </table>
                    </div>

                </div> </div>

                <div class="panel-group" id="puck_accordion">

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#puck_accordion" href="#puck_base_details">PUCK details </a>
                        </h4>
                    </div>
                    <div id="puck_base_details" class="panel-collapse collapse in">
                        <div id="puck_basics" class="panel-body"> </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#puck_accordion" href="#puck_vpn_details">PUCK VPN details </a>
                        </h4>
                    </div>
                    <div id="puck_vpn_details" class="panel-collapse collapse">
                        <div id="puck_vpn_basics" class="panel-body"> </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#puck_accordion" href="#puck_vpn_client_details">PUCK VPN client details</a>
                        </h4>
                    </div>
                    <div id="puck_vpn_client_details" class="panel-collapse collapse">
                        <div id="puck_vpn_client_basics" class="panel-body"> </div>
                    </div>
                </div>

                </div>

            </div>

            <!-- vpn stuff -->

            <div class="tab-pane fade" id="puck_vpn">

                <div class="row">

                    <div class="muted"> <h3 style="clear:both">VPN-a-tude</h3> </div>

                    <div id="puck_vid_notes">... notes....</div>
                    <div id="puck_users">... users....</div>

                    <div class="col-md-4" style="clear:both">

                        <h4> remote </h4>
                        <span>If connected to another PUCK and you don't see video... something is wrong!</span>


                        <div style="width:300px" id="remoteVideos"></div>

                    </span>
                    <input type="text" id="your-name" placeholder="your-name">
                    <button id="start-broadcasting" class="setup">Start Transmitting Yourself!</button>
                </section>
                
                <!-- list of all available conferencing rooms -->
                <table id="rooms-list" style="width: 100%;"></table>
                
                <!-- local/remote videos container -->
                <div id="videos-container"></div>
            </section>




<!--
                        <div style="width:300px" id="remoteVideos"></div>

                        <div><a style="text-decoration: none" href="#"><button data-loading-text="hanging up..." class="btn btn-warning nounderline" id="puck_disconnect" type="button"><span style="color: #fff !important;" class="glyphicon glyphicon-facetime-video"></span> <span style="color: #fff !important;">Disconnect</span></button></a></div>


-->
                    </div>


                    <div class="col-md-2"></div>
                    <div class="col-md-4">

                        <div style="padding:10px">
                            <b>Cat Chat!</b> <span class="muted small">instant messaging, PUCK style</span><br />
                        </div>

                        <div>
                            <div style="width:300px">
                                <div id="conversation"></div>
                                <input class="meow" id="meow" style="width:200px;" />
                                <input type="button" class="datasend" id="datasend" value="send" />
                            </div>
                            <div id="cat_chat" class="content"></div>
                        </div>

                    </div>
                </div>
                <div class="row">

                    <hr>

                    <div class="row" style="clear:both">
                        <div class="col-md-4">
                            <div id="localVideo"></div>
                        </div>
                    </div>


                    <button id="setup-meeting">Setup Meeting</button>

                    <div class="container-fluid">

                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#client_collapse">show/hide client logs</button>
                                <div id="client_collapse" class="collapse">
                                    
                                    <div id="ovpn_client_infinity" class="mCSB_container content">
                                        VPN client logs <hr> <!-- content -->
                                    </div>
                                </div>
                            </div>
                        </div> <!-- row -->

                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#server_collapse">show/hide server logs</button>

                                <div id="server_collapse" class="collapse">
                                    <div id="ovpn_server_infinity" class="mCSB_container content">
                                        VPN server logs <hr> <!-- content --> 
                                    </div>
                                </div>

                            </div>
                        </div>  <!-- row -->

                    </div> <!-- container -->

                </div>
            </div> <!-- vpn stuff -->


            <!-- trust/love -->

            <div class="tab-pane fade" id="puck_trust_explore">
                <div class="row-fluid marketing">
                    <div class="muted">
                        <h3 style="clear:both">Who do you trust?</h3>
                    </div>
                    <div>
                        ...
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="puck_trust_you">
                <div class="row-fluid marketing">
                    <div class="muted">
                        <h3 style="clear:both">Who trusts your PUCK?</h3>
                    </div>
                    <div>
                        ...
                    </div>
                </div>

            </div>

            <div class="tab-pane fade" id="puck_trust_generate">

                <h3 style="clear:both">Trusty!</h3>

                This is where you can create, choose, and see
                who you allow to come/go to/from your PUCK.
                Would you like to export:

                <p>

                <ul class="nav nav-tabs">
                    <li class="active"><a href="#puck_export" data-toggle="tab">Your PUCK data</a></li>
                    <li><a href="#puck_export_openvpn" data-toggle="tab">OpenVPN profile </a></li>
                    <li><a href="#puck_export_services" data-toggle="tab">Other services</a></li>
                </ul>

                        <!-- Tab panes -->
                <div class="tab-content">
                    <div class="tab-pane active" id="puck_export">
                        <p>
                        Other PUCKs may use the import feature (TBD :)) to 
                        import your PUCK's salient data.
                        <p>
                        Copy and paste the below and send it to a friendly PUCK owner.
                        <p>
                        This is essentially the same data what PUCKs
                        share when you add them in the UI by IP address.
                    </div>

                    <div class="tab-pane" id="puck_export_openvpn">
                        <p>
                        Other normal computers (e.g. non-PUCKs) who can
                        run OpenVPN will be able to use the below OVPN
                        profile to connect to your PUCK as an OpenVPN
                        client.

                        <p>
                        They must be able to connect to your PUCK server
                        from wherever they are coming from; in addition
                        only the "just make it work" security setting
                        allows OpenVPN connectivity from non-PUCKs by
                        default (higher security levels use a firewall
                        to block the VPN port until they a trusted PUCK
                        is trying to connect.)

                        <p>

                        Finally if your PUCK changes its IP address you'll
                        need to either generate a new profile or manually
                        change the IP address in the client.

                    </div>

                    <div class="tab-pane" id="puck_export_services">

                        <p>
                        You will also be able to stamp out PUCK slaves,
                        Laptop/generic computer/iOS/Android VPN
                        certificates so they can access the PUCK.

                        <p>

                        Finally there will be a set of capabilities;
                        you'll be able to assign them for everyone or for
                        specific individuals/computers.  Such capabilities
                        might give remote pucks the ability to:

                        <p>

                        <ul>
                        <li> incoming voice/SIP
                        <li> incoming Video/Sound
                        <li> incoming Drag-n-Drop files
                        <li> remote systems to surf as if they were at your PUCK's
                            physical location
                        <li> arbitrary network connections from your PUCK
                        <li> execute commands on your PUCK
                        <li> masquerade as your PUCK - essentially act on your
                            PUCK's behalf.  If Dan really trusts Charles,
                            Charles may initiate actions as though Dan's
                            PUCK was doing them.  This could cause long
                            chains of traffic/activity being passed
                            along, from PUCK A -&gt; B -&gt; C ... -&gt; N. Each
                            PUCK has to trust the PUCK attempting to
                            pass through it.
                        </ul>

                     </div> <!-- this tab pane -->

                </div> <!-- tab pane -->
    
            </div> <!-- tab pane -->

            <!-- message center -->
            <div class="tab-pane fade" id="puck_cloud">
                <div class="spacer30"></div>

                <div class="row">
                    <div class="col-md-6 column">
                        <div id="puck_cloud_filez"> 
                            <h3> What's in the vault? </h3>
                        </div>
                        <div class="row-fluid marketing">
                            <table id="puck_cloud_file_listing" class="table table-condensed table-hover table-striped">
                                <tr><td><strong> files </strong> </td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6 column">
                        <div id="puck_cloud_filez2"> 
                            <h3> Add to a vault </h3>
                            <small class="text-muted">When connected this will transfer to the remote system</small>
                            <br />
                        </div>
                        <div class="row-fluid marketing">
                            <form action="/up" method="post" enctype="multipart/form-data">
                                <input id="uppity" type="file" name="uppity" multiple="multiple" />
                            </form> 
                        </div>
                    </div>
                </div>
            </div>

            <!-- message center -->
            <div class="tab-pane fade" id="messages">
                <div class="spacer30"></div>
                <div id="event_messages"> 

                    Possible entries here include notices of missed calls, 
                    files that have been dropped off, rejected calls, 
                    typed missives, etc., etc.

                    <p>

                    For now simply a log of events... calls coming/going,
                    plus additions/deletions of PUCKs.

                </div>
             </div>
         </div> <!-- tab content -->

        <!-- spacer n feets below -->

        <div class="btn-toolbar"> <span></span></div>
        <div class="btn-toolbar"> <span class="spacer100"></span></div>

        <div class="footer" id="puck_footy">
            <p id='ip_diddy' class="text-muted credit">no electrons were harmed in the making of this footer</p>
        </div>

    </div>


<!-- <% include foot %> -->
<script type="text/javascript" src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript" src='/js/jquery-ui.1.9.2.min.js'></script>
<script type="text/javascript" src='/js/bootstrap.js'></script>
<script type="text/javascript" src='/js/moustache.js'></script>
<script type="text/javascript" src='/js/jquery.adipoli.min.js'></script>
<script type="text/javascript" src='/js/jquery.json-2.4.min.js'></script>
<script type="text/javascript" src='/js/jquery.inputmask.js'></script>
<script type="text/javascript" src="/js/underscore-min.js"></script>

<script type="text/javascript" src='/js/spin.js'></script>
<script type="text/javascript" src='/js/jquery.blockUI.js'></script>
<script type="text/javascript" src='/js/jquery.avgrund.js'></script>
<script type="text/javascript" src="/js/jquery.bootstrap-growl.min.js"></script>
<script type="text/javascript" src="/js/bootstrap-paginator.js"></script>

<!-- put a sock in it -->
<script type="text/javascript" src="/socket.io/socket.io.js"></script>

<script type="text/javascript" src="/js/jquery.filer.js"></script>
<script type="text/javascript" src="/js/jquery.mCustomScrollbar.concat.js"></script>
<script type="text/javascript" src="/js/simplewebrtc.js"></script>

<!-- the amazing rtc stuff -->
<script type="text/javascript" src='/js/PeerConnection.js'>


<script>
//
// after all is said and done... let the JS fur fly
//

var other_puck = "local"

// poll until we get something, then stop polling
var vault_poll     = 1000
var already_polled = false
var vpn_started    = false

var browser_ip  = ""
var remote_sock = ""
var socky_love  = false
var my_puck     = {}

var ovpn_slogs = 'openvpn_server_logs'
var ovpn_clogs = 'openvpn_client_logs'

// conf file fodder
var PUCK_TIMEOUT         = 5000 // 5 seconds should be enough for anyone!
var PREGNANT_PAUSE       = 3000 // 5 seconds should be enough for anyone!
var PUCK_RECONNECT_DELAY =  100

// for web rtc
var puck_meeting = {}

// xxx - from http://soundbible.com/1411-Telephone-Ring.html
ring = new Audio("media/ringring.mp3") // load it up

$(document).ready(function () {
    
    var image     = ""
    // var puck_id   = ""

    var tt = ['puck_top_left', 'puck_top_cog', 'puck_top_home', 'puck_top_skull', 'puck_top_ewe', 
              'puck_top_love', 'puck_top_cloud', 'puck_top_messages', 'puck_help', 'puck_video', 'puck_git']

    for (var i = 0 ; i < tt.length; i++) {
        $('#' + tt[i]).popover( {delay: { show: 200, hide: 200 }, trigger: "hover", placement: "bottom"})
    }

    // disable a/href pushing if disabled
    $('body').on('click', 'a.disabled', function(event) {
        event.preventDefault()
    })
    
    // enable tabs
    $('.ul nav-tabs a').click(function (e) { e.preventDefault(); $(this).tab('show') })

    // enable tabs
    $('#puck_trust_generate a').click(function  (e) { e.preventDefault(); $(this).tab('show') })
    $('#puck_trust_you a').click(function       (e) { e.preventDefault(); $(this).tab('show') })
    $('#puck_trust_explore a').click(function   (e) { e.preventDefault(); $(this).tab('show') })

    // enable some special buttons
    $('#puck_panic').click(function     (e) { panic_button() })
    $('#restart_server').click(function (e) { restart_server() })
    $('#stop_server').click(function    (e) { stop_server() })

    // log areas
    $("#ovpn_client_infinity").mCustomScrollbar({ scrollButtons:{ enable:true } })
    $("#ovpn_server_infinity").mCustomScrollbar({ scrollButtons:{ enable:true } })
    $("#cat_chat").mCustomScrollbar({ set_height: 200, set_width: 600, scrollButtons:{ enable:true } })

    //
    // setup user drag/click files to browser
    //
    drag_and_puck()

    // load up filenames already in vault
    load_vault()
    
    //
    // user clicks vpn, and....
    //
    // ring them gongs
    $('body').on('click', '.puck_vpn', function(e) {
        e.preventDefault()
        // id.substr(9) == puck id
        // possibly a better way to get name :)
        event_connect('outgoing', $(this).parent().parent().find('.puckname').text())

        var vpuckid = $("#puckid").val()
        var ipaddr  = $("#ipaddr").val()
        var target  = $("#name").val()
        puck_vpn(this, vpuckid, ipaddr)
        
    })

    //
    // user clicks create, and....
    //
    // build suspense....
    $('body').on('click', '#puck_button_create', function(event) { 
        console.log('hijax create')
        event.preventDefault()
    
        var ip_addr = $("#ip_addr").val()
    
        puck_create(this, ip_addr)
    
    })

    // toss your ip in the footer
    get_ip('#ip_diddy')

    // ... bye bye
    $('body').on('click', '#puck_disconnect', function() { 
        event_hang_up() 
    })
    $('body').on('click', '#halt_vpn_client', function() { 
        alert('bye-bye vpn')
        event_hang_up() 
    })

    // mwahaha
    $('body').on('click', '#puck_help', function() { 
        alert('yeah... right... you do it!')
    })

    // pleased to meet me, whomever I am
    $.get('/ping', function(puck) {
        my_puck = puck
    
        console.log('my name/id/status are: ', my_puck.name, my_puck.pid, my_puck.status)
    
        my_puck_status = 'Name: ' + my_puck.name + '<br />Status: ' + my_puck.status + '<br />ID: ' + my_puck.pid
    
        if (my_puck.status == "OK") {
            // $('#puck_status').addClass('btn-success').removeClass('disabled')
            $('#puck_status').addClass('green').removeClass('red')
        }
        else {
            $('#puck_status').removeClass('green').addClass('red')
            // $('#puck_status').removeClass('btn-success').addClass('disabled')
        }
    
        $('#puck_status').attr("data-toggle", "popover").attr("data-placement", "bottom").attr("data-html", "true").attr("title", "PUCK Status").attr("data-content", my_puck_status).popover({delay: { hide: 200 }, trigger: "hover"})
    
        console.log('my name/id/status are: ', my_puck.name, my_puck.pid, my_puck.status)
    
        my_puck_status = 'Name: ' + my_puck.name + '<br />Status: ' + my_puck.status + '<br />ID: ' + my_puck.pid
    
        if (my_puck.status == "OK")
            // $('#puck_status').addClass('btn-success').removeClass('disabled')
            $('#puck_status').addClass('green').removeClass('red')
        else
            $('#puck_status').removeClass('green').addClass('red')
            // $('#puck_status').removeClass('btn-success').addClass('disabled')
    
        $('#puck_status').attr("data-toggle", "popover").attr("data-placement", "bottom").attr("data-html", "true").attr("title", "PUCK Status").attr("data-content", my_puck_status).popover({delay: { hide: 200 }, trigger: "hover"})
    
        // get the other pucks we know about from local REST
        $.getJSON('/puck', function(pucks) {
    
            if (pucks.length == 1) {
                $('#puck_friends').append("<div class='row'><div class='col-md-4 top-spacer-50'>It appears you have no friends... but don't worry, we won't tell everyone you're a loser.  Click on the green/white plus button above to add another PUCK, assuming their owner would be willing to talk to you (and you know their IP address or hostname).  Maybe I can link in some <a target='_blank' href='https://www.youtube.com/watch?v=oHg5SJYRHA0'>youtube videos</a> and break out <a target='_blank' href='http://www.amazon.com/Orville-Redenbacher-Butter-Popcorn-10-Count/dp/B0049M7LA2'>the popcorn</a> if that doesn't work for you.'</div></div>")
            }

            // loop over all valid pucks
            $.each(pucks, function(key, val) {
    
                $('#puck_loading').hide()
    
                // for each puck get more detailed data
                $.getJSON('/puck/' + val, function(puckinfo) {
                    console.log('v/p')
                    console.log(val)
        
                    // bit of a race condition... figure out how to get the puckID of
                    // this PUCK (see above) prior to these so I can not put it up
                    // on the screen... lots of ways to do this....
                    if (my_puck.pid != val) {
        
                        var name        = truncate(puckinfo.name)
                        var owner       = truncate(puckinfo.owner.name)
                        var email       = truncate(puckinfo.owner.email)
                        var puckid      = puckinfo.PUCK_ID
                        var ipaddr      = puckinfo.ip_addr
                        var all_ips     = puckinfo.all_ips
                        var port        = puckinfo.port
                        var ipaddr_ext  = puckinfo.ip_addr_ext
                        var port_ext    = puckinfo.port_ext
                        var proto       = puckinfo.proto
                        var image       = puckinfo.image
                        var ca          = puckinfo.vpn.ca
                        var key         = puckinfo.vpn.key
                        var cert        = puckinfo.vpn.cert
                        var dh          = puckinfo.vpn.dh
                        
                        var vpn_form    = 'vpn_form_' + puckid
                 
                        console.log('puckasaurus:')
                        console.log(puckinfo)
                        console.log('puck particulars:')
                        console.log(puckinfo)
                 
                        if (typeof port === 'undefined' || port == "") {
                            // XXXX
                            port     = 8080
                            port_ext = port
                        }
                        if (typeof ipaddr_ext === 'undefined' || ipaddr_ext == "") {
                            ipaddr_ext = ipaddr
                        }
                        if (typeof proto === 'undefined' || proto == "") {
                            proto = 'https'
                        }
                 
                        var puck_url         = proto + '://' + ipaddr_ext + ':' + port_ext
                 
                        // have to kill spaces... die, die, die!
                        puckid = puckid.replace(/\s+/g, '');
                 
                        var trunc_puckid     = truncate(puckid)
                 
                        // keep track of everything
                        all_puck_ids[puckid] = puckid
                 
                        var puck = {
                           puckid         : puckid,
                           name           : name,
                           trunc_puckid   : trunc_puckid,
                           owner          : owner,
                           email          : email,
                           image          : image,
                           ipaddr         : ipaddr,
                           all_ips        : all_ips,
                           url            : puck_url,
                           vpn_form       : vpn_form,
                           span_owner     : 'span_' + owner,
                           span_email     : 'span_' + email
                           }
                 
                        // basic single puck layout, 'stache style
                        var template = 
                             '<div class="col-md-3">'                                                                  + 
                              '<div class="thumbnail" style="background-color: #eaf1f1" id="{{puckid}}">'              +
                                 '<a href="/puck_details.html?puckid={{puckid}}">'                                     +
                                 '<img id="{{puckid}}" width=128 style="padding: 4;" src="{{image}}"></a> <br />'      +
                                 '<div class="caption">'                                                               +
                                    '<span>PUCK: </span><span class="puckname"><b>{{name}}</b></span> <br />'          +
                                    '<span id="{{owner}}"> Owner: <strong>{{owner}}</strong>   </span> <br />'         +
                                    '<span id="{{ipaddr}}">Server: <strong>{{ipaddr}}</strong> </span> <br />'         +
                                    '<span id="{{ipaddr}}">URL: <strong>{{url}}</strong> </span> <br />'               +
                                    '<span id="{{email}}"> Email: <strong>{{email}}</strong>   </span> <br />'         +
                                    '<form id="{{vpn_form}}" action="/vpn/start" method="POST">'                       +
                                    '<input style="display:none" id="puckid" name="puckid"  value={{puckid}}>'         +
                                    '<input style="display:none" id="ipaddr" name="ipaddr"  value={{ipaddr}}>'         +
                                    '<input style="display:none" name="vpn_action" value="VPN" />'                     +
                                    '<button type="submit" id="puck_vpn" style="margin: 10px" class="puck_vpn meter cherry btn disabled">Call</button>' +
                                    '</form>'                                                                          +
                                 '</div>'                                                                              +
                              '</div>'                                                                                 +
                            '</div>'                                                                                   
                 
                         //   '</div>'                                                                                 +
                         //'</li>'
                 
                         // let the 'stache go to town!
                         var puck_html = Mustache.to_html(template, puck);
                 
                         // $('#puck_details').html(html);
                         $("#puck_friends").append(puck_html)
                         // console.log('\nMUSTACHE!!!:\n' + puck_html + '\n\n')
                 
                         // add the real ID
                         // CHANGE THE ID!   make the VPN button point to the right PUCK
                         $('#puck_vpn').attr('id', 'puck_vpn_' + puckid)
             
                         // check interval
                         ping_poll = 10000
             
                         // pingy - check if system is up... do it once, then at regular intervals
                         puck_ping(all_ips, puckid, puck_url)
                         // args are function, timeout, function (ips, pid, and url)
                         setInterval(puck_ping, ping_poll, all_ips, puckid, puck_url)
                 
                         // start images in gray, color (if avail) on mouseover
                         console.log('adipoli: ' + puckid)
                         $('#' + puckid).adipoli({
                           'startEffect' : 'grayscale',
                           'hoverEffect' : 'normal'
                         })
             
                    } // else ... pucks other than this one
                    else {
                        my_puck = puckinfo
                        print_puck(puckinfo.PUCK_ID, puckinfo, ['#puck_basics', '#puck_vpn_basics', '#puck_vpn_client_basics'])
                    }
                })
            })
        })
    })

    detect_webRTC('puck_rtc_health_check')

    // message data
    list_events()
    
    setTimeout(function(){socket_looping()},PREGNANT_PAUSE)

    // get my puck data
    // who_am_i()

})

//
// helper functions for initial PUCK prototype
//
// draw pucks, delete pucks, start vpns... various things
//

// track all puck IDs...
all_puck_ids   = []

// overall connection state
var puck_current            = {}
    puck_current.incoming   = false,
    puck_current.outgoing   = false,
    last_file               = "",
    killed_call             = false;

var puck_status     = {},
    old_puck_status = {}

var incoming_ip = "?"

var ring = ""

var browser_ip = ""

var poll = 500  // 2x a second
var poll = 1000  // once a second
var poll = 5000  // every 5 secs

PUCK_SOCK_RETRY = 5000

// helper from http://stackoverflow.com/questions/377644/jquery-ajax-error-handling-show-custom-exception-messages
function formatErrorMessage(jqXHR, exception) {

    if (jqXHR.status === 0) {
        return ('Please verify your network connection.');
    } else if (jqXHR.status == 404) {
        return ('The requested page not found. [404]');
    } else if (jqXHR.status == 500) {
        return ('Internal Server Error [500].');
    } else if (exception === 'parsererror') {
        return ('Requested JSON parse failed.');
    } else if (exception === 'timeout') {
        return ('Time out error.');
    } else if (exception === 'abort') {
        return ('Ajax request aborted.');
    } else {
        return ('Uncaught Error.\n' + jqXHR.responseText);
    }
}

// ping myself
function who_am_i() {
    $.get('/ping', function(puck) {
        console.log('my name/id/status are: ', puck.name, puck.pid, puck.status)
        puck_status = 'Name: ' + puck.name + '<br />Status: ' + puck.status + '<br />ID: ' + puck.pid
        // get my own data
        $.getJSON('/puck/' + puck.pid, function(puckinfo) {
            console.log('my PUCK:')
            my_puck = puckinfo
            console.log(my_puck)
        })
    })
}

//
// some funs to grab the event data
//
function list_events() {

    console.log('listing events')

    var url = "/events"

    var jqXHR_list = $.ajax({
        url: url,
        dataType: 'json'
    }) 

    jqXHR_list.done(function (data, textStatus, jqXHR) {
        console.log('jxq list events wootz')
        console.log(data)

        var cat_herd = []

        for (var i = 0; i < data.length; i++) {
            var cat = data[i]

            // do the in/out calls first
            if (cat == 'vpn_client_connected' || cat == 'vpn_server_connected') {
                populate_events(cat)
            }
            else {
                cat_herd[i] = cat
            }

        }

        // iterate over alphabetized list and suck in the data
        _.each(_.sortBy(cat_herd, function (catty) {return catty}), populate_events)

        //  populate_events(cat)

    }).fail(function(err) {
        console.log('events errz on hangup' + err)
    })

}

//
// put the category data where it belongs
//
function populate_events(cat) {

    console.log('sucking in table data for ' + cat)

    var url       = "/events/" + encodeURIComponent(cat)

    if      (cat == 'vpn_client_connected') _cat = 'Calls made'
    else if (cat == 'vpn_server_connected') _cat = 'Calls'
    else                                    _cat = cat

    var cat_e     = cat + "_table_events"

    var base_table = '<div class="row-fluid marketing">'                                                            +
                     '<div class="spacer20"> </div>'                                                                +
                     '<div><h4 class="text-primary">'    + _cat + '</h4></div>'                                     +
                     '<table class="table table-condensed table-hover table-striped" id="' + cat_e + '"></table>'   +
                     '<ul id="' + cat + '_pager"></ul>'                                                             +
                     '</div>'                                                                                       +
                     '</div>'

    var n = 0

    var t_headers = ""
    var t_rows    = ""

    $.getJSON(url, function(data) {
        console.log('chopping up event data for ' + cat)
        $.each(data, function(index) {
            t_headers = ""
            var obj   = data[index]

            t_rows    = t_rows + '<tr>'
            n++
            for (var prop in obj) {
                if (obj.hasOwnProperty(prop)){
                    t_headers = t_headers + '<td><strong>' + prop + '</strong></td>'
                    t_rows    = t_rows + '<td>' + obj[prop] + '</td>'
                }
            }
            t_rows = t_rows + '</tr>\n'
        })
        t_rows = "<tr>" + t_headers + "</tr>" + t_rows

        // finally paint everything on
        $('#event_messages').append(base_table)
        $('#' + cat_e).append(t_rows)

        // $('#' + cat_e + ' > tbody > tr:first').before('<tr><td></td>' + t_headers + '</tr>')
    })

}

// http://stackoverflow.com/questions/133925/javascript-post-request-like-a-form-submit
function post(url, parameters) {
    var form = $('<form></form>');

    form.attr("method", "post");
    form.attr("action", url);

    $.each(parameters, function(key, value) {
        var field = $('<input></input>');

        field.attr("type", "hidden");
        field.attr("name", key);
        field.attr("value", value);

        form.append(field);
    });

    // The form needs to be a part of the document in
    // order for us to be able to submit it.
    $(document.body).append(form);
    form.submit();
}

function state_cam(state, location) {

    console.log('cam will be... ' + state + ' @ ' + location)

    if (location == 'local') var loc = '/'
    // use proxy to other PUCK
    else                     var loc = ':7777'

    if (state == 'up') {
        candid_camera(loc)
        state_audio('unmute')
        state_video('resume')
    }
    else if (state == 'down') {
        candid_camera(loc)
        state_audio('mute')
        state_video('pause')
    }
    else {
        console.log('... well... you... blew it; unknown state: ' + state)
    }

}

//
// pause/resume webrtc audio
//
function state_audio(state) {

    console.log('audio will be... ' + state)

    if (state == 'mute') {
        console.log('... muting audio...')
        // my_webrtc.pauseVideo
    }
    else if (state == 'unmute') {
        console.log('... audio on...')
        // my_webrtc.pauseVideo
    }
    else {
        console.log('... well... you... blew it; unknown state: ' + state)
    }
}

//
// pause/resume video
//
function state_video(state) {

    console.log('video will be... ' + state)

    if (state == 'pause') {
        console.log('... pausing vid...')
        // my_webrtc.pauseVideo
    }
    else if (state == 'resume') {
        console.log('... carry on...')
        // my_webrtc.pauseVideo
    }
    else {
        console.log('... well... you... blew it; unknown state: ' + state)
    }

}

//
// when vpn status/state changes... set lights flashing, whatever
//
function state_vpn(state, browser_ip) {

    if (state == "incoming") {
        // ensure video button is enabled if a call is in progress
        $('#puck_video').addClass('green').addClass('pulse')

        console.log('incoming ring from ' +  puck_status.openvpn_server.client)
        incoming_ip = puck_status.openvpn_server.client
        // ring them gongs, etc.

        if (!puck_status.browser_events[browser_ip].notify_ring) {
            event_connect("incoming", incoming_ip)
            puck_status.browser_events[browser_ip].notify_ring = true
        }

        puck_current.incoming = true
        puck_status.browser_events[browser_ip].notify_file = true
        other_puck = puck_status.openvpn_server.client
    }

    if (state == "outgoing") {
        $('#puck_video').addClass('green').addClass('pulse')
        console.log('outgoing ring!')
        state_ring('true')
        puck_status.browser_events[browser_ip].notify_ring = true

        fire_puck_status(puck_status)

        if (!puck_status.browser_events[browser_ip].notify_ring) {
            event_connect("outgoing", incoming_ip)
            puck_status.browser_events[browser_ip].notify_ring = true
        }

        other_puck = puck_status.openvpn_client.server

        puck_current.outgoing = true

        // go to vpn page
        $('body').removeClass('avgrund-active');
        $('#puck_vpn').click()
        window.location.href = "/puck.html#puck_vpn"
        // window.location.href = "vpn.html"
    }

}

// the bells... the bells... make them stop!
function state_ring(sound) {

    if (!sound) {
        try {
            ring.pause();
            ring.currentTime = 0;
            console.log('bells... no more?')
        }
        catch(e) {
            console.log("haven't played anything yet")
        }
    }
    else {
        // ring ring - play sound
        ring.play()
    }

}

//
// calls, in or out
//
function event_connect(direction, puck) {

    console.log('connexting')

    //
    // energize modals
    //
    // "Avgrund is Swedish for abyss"
    $('#' + direction).avgrund({
        height: 120,
        openOnEvent: false,
        width: 600,
        holderClass: 'custom',
        showClose: true,
        showCloseText: 'Close',
        enableStackAnimation: true,
        onBlurContainer: '.container',
        template: '<div class="row">' +
                  '<div id="puck_ring_img" class="col-md-4"></div>' +
                  '<a style="text-decoration: none" href="#puck_vpn"><div class="col-md-4 top-spacer50"><button class="btn btn-primary nounderline" id="puck_answer" type="button"><span style="color: #fff !important;" class="glyphicon glyphicon-facetime-video"></span> <span id="vpn_target" style="color: #fff !important;">Calling</span></button></div></a>'  +
                  '<div class="col-md-4 top-spacer50"><button data-loading-text="hanging up..." class="btn btn-warning nounderline" id="puck_disconnect" type="button"><span style="color: #fff !important;" class="glyphicon glyphicon-facetime-video"></span> <span style="color: #fff !important;">Disconnect</span></a></button></div>' +
                  '</div>'
        })

    state_ring('true')

    // xxx - conf file, obv....
    var ring_img = '<img src="/img/ringring.gif">'

    // after things popup, add caller/callee
    if (direction == "incoming") {
        $('#vpn_target').on('change', '#vpn_target').html('Call from ' + puck)
    }
    else {
        $('#vpn_target').on('change', '#vpn_target').append(' ' + puck)
    }

    $('#puck_ring_img').on('change', '#puck_ring_img').html(ring_img)

}

//
// hang up the phone, return to home
//
function event_hang_up() {

    console.log('hanging up!')

    state_ring('false')

    // i has gone
    local_socket.emit('remove_puck', my_puck.PUCK_ID);

    var url = "/vpn/stop"

    var jqXHR_stopVPN = $.ajax({
        url: url,
        // probably shouldn't, but...
        // async:false,
        dataType: 'json',
    }) 

    jqXHR_stopVPN.done(function (data, textStatus, jqXHR) {
        console.log('jxq hangup wootz')
        console.log(data)
    }).fail(function(err) {
        console.log('errz on hangup' + err)
        alert('error on hangup!')
    })

    // kill the CSS UI signs
    remove_signs_of_call()

    fire_puck_status(puck_status)

    console.log('waiting 2 secs to kill...?')

    setTimeout(function(){
        window.location.href = "/puck.html"
    }, 2000)

    $('body').removeClass('avgrund-active');

    // if (window.location.pathname.split( '/' )[1] != "puck.html") {
    //     setTimeout(window.location.href = "/puck.html", 2000)
    // }

}

//
// get the current user's IP addr, put it where the element is
//
function get_ip(element) {
    var url = "/getip"
    var jqXHR_getIP = $.ajax({
        url: url,
        dataType: 'json',
    }) 

    jqXHR_getIP.done(function (data, textStatus, jqXHR) {
        console.log('jxq getIP wootz')
        console.log(data)
        browser_ip = data.ip
        $('#ip_diddy').prepend("Your IP address is: " + browser_ip + " ... ");
    }).fail(function(err) {
        console.log('errz on getIP' + err)
    })

}

//
// fire up the VPN
//
function puck_vpn(element, puckid, ipaddr) {

    console.log('firing up VPN')
    console.log(puckid, ipaddr)

    $(element).text("connecting...").removeClass("btn-success").addClass("btn-danger")

    var pvpn = $.ajax({
        type: "POST",
        url: "/vpn/start",
        data: {"puckid": puckid, "ipaddr": ipaddr}
    })

    pvpn.done(function(msg) {
        console.log("posto facto")
    })
    pvpn.fail(function(xhr, textStatus, errorThrown) {
        console.log('failzor -> ' + xhr)
    })

}

// whimsey
function go_puck_or_go_home() {
    console.log('go puck or...')
    window.location.href = location.href
}

function puck_create(element, ip_addr) {

    $(element).text("creating...").removeClass("btn-success").addClass("btn-danger")

    // adapted from http://css-tricks.com/css3-progress-bars/
    console.log('barberizing -> ' + ip_addr)
    // get width, nuke width, animate to old width
    $(element).data("oldWidth", $(element).width() * 2)
        .width(0)
        .animate({ width: $(element).data("oldWidth") }, 1000);

    console.log('touch the hand of ... ')
    console.log('ip addr: ' + ip_addr)

    var post_data         = {}
    post_data.ip_addr     = ip_addr
    post_data.puck_action = "CREATE"
    post_data = JSON.stringify(post_data)
    
    $.ajax({
        type: "POST",
        url: "/form",
        headers: {
            'Content-Type': 'application/json',
        },
        data: post_data,
        success: function(data, status) {
            console.log('suck... sess.... ')
            // yes... I suck
            setTimeout(go_puck_or_go_home, 2000)
        },
        fail: function(data, err) {
            console.log('fuck... me')
            // yes... I suck
            setTimeout(go_puck_or_go_home, 2000)
        }
    })

}

//
// well...  sort of... pingish... send ping request to PUCK server
//
// farm out https requests to remote systems since js/jquery balk at that kinda shit
//
function puck_ping(all_ips, puckid, url) {

    console.log('in puck_ping')
    console.log(puckid, url)
    console.log(all_ips)

    // var ping_url = '/sping/' + puckid + "/" + all_ip_string
    var ping_url = '/sping/' + puckid + "/" + all_ips

    console.log('pinging ' + puckid + ' ... URL ... ' + ping_url)

    var ping_id  = ''

    // if we're alive, this will get put in
    var vpn_form = 'vpn_form_' + puckid

    // element_id='puck_' + id + '_ip_addr'
    var element_id='puck_vpn_' + puckid

    $.ajax({url: ping_url, cache: false, 
        success: function(data) {
            console.log('success with ' + element_id) 
            console.log(data)

            // make the button clickable and green
            if (data.status == "OK") {
                console.log('success with ' + element_id) 
                // console.log('ok...')
                $('#'+element_id).addClass('btn-success').removeClass('disabled')
            }
            else {
                console.log('not ok...')
                $('#'+element_id).removeClass('btn-success').addClass('disabled')
            }

        },
        error: function(error){
            console.log( "ping error for " + ping_url)
            $('#'+element_id).removeClass('btn-success').addClass('disabled')
            console.log(error)
        },
        fail: function(error) {
            console.log( "ping failure for " + ping_url)
            console.log(error)
            $('#'+element_id).removeClass('btn-success').addClass('disabled')
        }
        })
   
// console.log('post-pingy ' + puckid + '... putting into ' + element_id)

}

//
// until I find a good one
//
function truncate(string){
  var MAX_STRING = 20
  if (string.length > MAX_STRING)
     return string.substring(0,MAX_STRING - 3)+'...';
  else
     return string;
};


//
// xxx... don't want to harass the user by ringing all the time...
// may or may not be needed
//
function check_ring() {
    console.log("have I rang?");
}

function ajaxError( jqXHR, textStatus, errorThrown ) {
    console.log('jquery threw a hair ball on that one: ' + textStatus + ' - ' + errorThrown);
}

//
// ... snag /status
//
function get_status() {

    console.log('get STATUS')

    var url = "/status"

    var jqXHR_get_status = $.ajax({ url: url, })

    jqXHR_get_status.done(function (data, textStatus, jqXHR) {
        // console.log('status wootz\n' + data)
        puck_status = JSON.parse(data)
        console.log("INITIAL STATUS: " + JSON.stringify(puck_status))
    }).fail(ajaxError);

}


//
// ... snag all the various socket chatter
//
function socket_looping(){

    console.log('status loop')

    // local == our PUCK
    local_socket = io.connect('/', {
        'connect timeout': PUCK_TIMEOUT,
        // 'try multiple transports': true,
        'reconnect': true,
        'reconnection delay': PUCK_RECONNECT_DELAY,
        'reconnection limit': PUCK_TIMEOUT,
        'max reconnection attempts': Infinity,
        'sync disconnect on unload': false,
        'auto connect': true,
        'force new connection': true
        })

    // sow the seed o' doubt
    get_status()

    local_socket.socket.on('connect', function(sock){
        console.log('[+++] - general connext note')

        // everyone loves cat facts!
        cat_chat(local_socket, 'local')

    })

    local_socket.on('puck_status', function (data) {
        console.log('[@] + cat facts... wait...no... status :!:')
        console.log(JSON.stringify(data))
        console.log(typeof data)

        // puck_status = JSON.parse(data)
        puck_status = data
            
        // if something is new, do something!
        if (! _.isEqual(old_puck_status, puck_status)) {
            console.log('something new in the state of denmark!')
            console.log(puck_status)
            console.log('vs\n')
            console.log(old_puck_status)

            console.log(typeof puck_status)
            console.log(typeof old_puck_status)
            old_puck_status = puck_status
            status_or_die()

            // try to connect to the remote puck socket.io
            try { 
                console.log('trying...')
                console.log(data.openvpn_client)
                if (data.openvpn_client.vpn_status == "up") {
                    var url = ':7777'
                    console.log('trying to connect to... ' + url)
                    // try remote connecting, and keep it up until javascript wears itself out
                    put_a_sock_in_it(url)
                    setTimeout('put_a_sock_in_it', PUCK_SOCK_RETRY, url)
                }
            }
            catch (e) { console.log('vpn aint ready') }

        }
        else {
            console.log('same ol, same ol')
        }
    })
   
    local_socket.on('error', function(err){
        console.log('local errz ' + JSON.stringify(err))
    })

    local_socket.on('reconnect', function(d) { 
        console.log ('reconnect') 
        fire_puck_status(puck_status)
    })

    local_socket.on('error',            function(d) { console.log ('error') ; console.log(d) })
    local_socket.on('connecting',       function(d) { console.log ('connecting') })
    local_socket.on('reconnecting',     function(d) { console.log ('reconnecting') })
    local_socket.on('connect_failed',   function(d) { console.log ('connect failed') })
    local_socket.on('reconnect_failed', function(d) { console.log ('reconnect failed') })
    local_socket.on('close',            function(d) { console.log ('close') })
    local_socket.on('disconnect',       function(d) { console.log ('disconnect') })


    // OVPN logs for client/server
    local_socket.on(ovpn_clogs, function (data) {
        console.log('client: ' + data.line)
        $("#ovpn_client_infinity .mCSB_container").append('<div class="log_line">' + data.line + "</div>")
        $("#ovpn_client_infinity").mCustomScrollbar("update")
        $("#ovpn_client_infinity").mCustomScrollbar("scrollTo",".log_line:last",{scrollInertia:2500,scrollEasing:"easeInOutQuad"})
    })
    
    local_socket.on(ovpn_slogs, function (data) {
        console.log('server: ' + data.line)
        $("#ovpn_server_infinity .mCSB_container").append('<div class="log_line">' + data.line + "</div>")
        $("#ovpn_server_infinity").mCustomScrollbar("update")
        $("#ovpn_server_infinity").mCustomScrollbar("scrollTo",".log_line:last",{scrollInertia:2500,scrollEasing:"easeInOutQuad"})
    })


}

function isEmpty(obj) {
    return Object.keys(obj).length === 0;
}


//
// get events, status... or... well....
//
// this processes missives from the server and potentially says something about it
//
function status_or_die() {

    console.log('sailing on the sneeze of cheeze')
    console.log(puck_status)
    console.log('I hear something... from... ' + browser_ip)

    if (typeof puck_status.browser_events == "undefined" || typeof puck_status.browser_events[browser_ip] == "undefined") {
        console.log('stuffing browser events...')
        puck_status.browser_events = {}
        puck_status.browser_events[browser_ip] = { "notify_add":false, "notify_ring":false, "notify_file":false}
    }

    // if someone has added you, create a modest sized bit of text that tells you 
    // and hopefully won't fuck up anything you're doing

    console.log('a friend...?')
    if (puck_status.events.new_puck.length && ! puck_status.browser_events[browser_ip].notify_add) {
        var remote_ip = puck_status.events.new_puck
        console.log(remote_ip + ' added!')
        // a bit down from the top, and stay until wiped away or refreshed
        $.bootstrapGrowl(remote_ip + " added your PUCK as a friend (refresh page to see details)", {offset: {from: 'top', amount: 70}, delay: -1})

        puck_status.browser_events[browser_ip].notify_add = true
// <input type="button" value="Reload Page" onClick="history.go(0)">
    }

    console.log('incoming...?')

    // server... incoming ring
    if (puck_status.openvpn_server.vpn_status == "up") {
        state_vpn('incoming', browser_ip)
    }

    console.log('outgoing...?')

    // client... outgoing ring
    if (puck_status.openvpn_client.vpn_status == "up") {
        state_vpn('outgoing', browser_ip)
        // cat facts!
        state_cam(true, 'local')
    }

    // if nothing up now, kill any signs of a call, just to be sure
    if (puck_status.openvpn_client.vpn_status != "up" && puck_status.openvpn_server.vpn_status != "up") {
        other_puck = "local"
        // xxx - one for out, one for in?
        puck_status.browser_events[browser_ip].notify_ring = false
        remove_signs_of_call()
        $('body').removeClass('avgrund-active');
    }

    if (puck_status.openvpn_client.vpn_status != "up") puck_current.outgoing = false
    if (puck_status.openvpn_server.vpn_status != "up") puck_current.incoming = false

    // did santa come?
    console.log('new toyz...?')
    if (puck_status.file_events.file_name.length && ! puck_status.browser_events[browser_ip].notify_file) {
        console.log('new file(z)!')
        // put in or lookup PiD, then owner/puck's name!
        $.bootstrapGrowl("New file: <strong>" + puck_status.file_events.file_name + "</strong>  ("  + puck_status.file_events.file_size + " bytes); from " + puck_status.file_events.file_from, {offset: {from: 'top', amount: 70}, delay: -1})

        puck_status.browser_events[browser_ip].notify_file = true
    }

    fire_puck_status(puck_status)

}

//
// when disconnected, kill all the UI signs we put up
// 
function remove_signs_of_call() {

    console.log('killing call signatures...')
    $('.puck_vpn').text("Call").removeClass("btn-danger")
    $('#puck_video').addClass('disabled')
    $('#puck_video').removeClass('green').removeClass('pulse')
    $('.avgrund-popin').remove();

}

//
// drag filenames from what's stored 
//

function load_vault() {

    console.log('loadin n setting up vault!')

    var jqXHR_files = $.ajax({
        url: '/down',
        dataType: 'json'
    }) 

    var table_rowz = []

    jqXHR_files.done(function (data, textStatus, jqXHR) {
        console.log('jxq file vault listing')
        console.log(data.files)

        var vault = []

        for (var i = 0; i < data.files.length; i++) {
            console.log(data.files[i])
            var file = data.files[i]
            table_rowz.push('<tr><td><a target="_blank" href="/uploads/' + data.files[i] + '">' + data.files[i] + '</a></td></tr>')
        }

        console.log(table_rowz)

        $('#puck_cloud_file_listing').append(table_rowz)

    })

}

function panic_button() {

    console.log('panic... not implemented yet... start really panicing!')

}

function restart_server() {

    var url = "/server/restart"

    var jqXHR_restart_server = $.ajax({
        url: url,
        dataType: 'json',
    }) 

    jqXHR_restart_server.done(function (data, textStatus, jqXHR) {
        console.log('jxq restart server wootz... of course...if the server were really restarting...')
        console.log(data)
    }).fail(function(err) {
        console.log('errz on restart... or is it?  ' + err)
    })

}

function stop_server() {

    var url = "/server/stop"

    var jqXHR_stopVPN = $.ajax({
        url: url,
        dataType: 'json',
    }) 

    jqXHR_stopVPN.done(function (data, textStatus, jqXHR) {
        console.log('jxq stop server wootz... of course...if the server were really dead...')
        console.log(data)
    }).fail(function(err) {
        console.log('errz on stop server... or maybe not ;) ' + err)
    })

}

//
// fire status to puck
//
// sinc == async or sync
//
function fire_puck_status(jstatus) {

    console.log('firing status off')
    console.log(typeof jstatus)
    jstatus = JSON.stringify(jstatus)

    var status_xhr = $.ajax({
        type: "POST",
        url: "/status",
        dataType: 'json',
        contentType: "application/json; charset=utf-8",
        data: jstatus,
        success: function(res) {
            console.log('status off!')
            console.log(res)
        },
        error: function (txtstat, e) {
            console.log('status failzor -> ' + JSON.stringify(txtstat))
            console.log(e)
        }
    })
        // ?
        // async: sink,
}


// draws the drag-n-drop box... need to call it anytime
// vpn state changes
function drag_and_puck() {

    console.log('draggin n puckin')

    console.log('drawin the box')

        // out with the old, in with the new
    $('.dragDropBox').remove()

    $('#uppity').filer({
        changeInput: '<div class="dragDropBox"><span class="message">CLICK -or- DROP files to upload <span style="font-size:200%"><br />' + other_puck + '</span></div>',
        appendTo   : '.dragDropBox',
        template   : '<img src="%image-url%" title="%original-name%" /><em>%title%</em>',
        maxSize    : 1024,
        uploadFile: {
            // url:         'https://10.217.62.1:8080/up',
            url:         '/up/' + other_puck,
            data:        {},
            beforeSend:  function(parent){parent.append('<div class="progress-bar" />');},
            success:     function(data, parent, progress){ },
            error:       function(e, parent, progress){ },
            progressEnd: function(progress){progress.addClass('done-erase');},
            onUploaded:  function(parent){ }
        },
        dragDrop: {
            dropBox:  '.dragDropBox',
            dragOver: function(e, parent){ $('.dragDropBox').addClass('hover'); },
            dragOut:  function(e, parent){ $('.dragDropBox').removeClass('hover'); },
            drop:     function(e, formData, parent){ $('.dragDropBox').removeClass('hover'); },
        },
        onEmpty    : function(parent, appendBox){ $(appendBox).removeClass('done'); },
        onSelect   : function(e,parent,appendBox){ $(appendBox).addClass('done'); }
    })

}


//
// try to go put a sock on the other PUCK
//
function put_a_sock_in_it(url) {

    console.log('keep trying...')
    try { remote_socket.disconnect() }
    catch (e) { console.log('nice catch of D/C!'); console.log(e) }

    remote_socket = io.connect(url, {
        'connect timeout': 5000, // 5 seconds should be enough
        'try multiple transports': true,
        'reconnect': true,
        'reconnection delay': 500,
        'reconnection limit': 5000,
        'max reconnection attempts': Infinity,
        'sync disconnect on unload': false,
        'auto connect': true,
        'force new connection': true
    })

    remote_socket.socket.on('connect', function(){

        console.log('[+] remote - connected to ' + url)

        console.log('my puck ' + JSON.stringify(my_puck))
        
        // if (typeof data != undefined && data.server != "undefined") {
        //     $('#conversation').append('<div class="muted small"><i>connected to ' + data.server + '</i></div>')
        // }

        remote_socket.on('cat_facts', function (data) {

            console.log('[@@@] - cat facts!')
            console.log(data)
           
            if (typeof data != undefined && data.fact != "undefined") {
                $('#ip_diddy').append('<br />' + data.fact)
                console.log(data.fact)
                console.log(data.server)
            }

            state_cam(true, 'remote')

        })
           
        remote_socket.emit('puck', 'foo', function (data) {
            console.log('[@] + hey pucks... ')
            console.log(data)
        })

        remote_socket.on('puck_status', function (data) {
            console.log('[@] + cat facts... wait...no... remote status!')
            status_or_die()
            console.log(data)
        })
           
        remote_socket.on('error', function(err){
            console.log('remote errz ' + JSON.stringify(err))
        })
           
        //cat_chat(remote_socket, my_puck.PUCK_ID)
        cat_chat(remote_socket, 'remote')

    })

    remote_socket.on('anything', function(data) {
        console.log('... something... anything.... ')
        console.log(data)
    })
           
           
    remote_socket.on('error',            function(d) { console.log ('error') ; console.log(d) })
    remote_socket.on('reconnect',        function(d) { console.log ('reconnect') })
    remote_socket.on('connecting',       function(d) { console.log ('connecting') })
    remote_socket.on('reconnecting',     function(d) { console.log ('reconnecting') })
    remote_socket.on('connect_failed',   function(d) { console.log ('connect failed') })
    remote_socket.on('reconnect_failed', function(d) { console.log ('reconnect failed') })
    remote_socket.on('close',            function(d) { console.log ('close') })
    remote_socket.on('disconnect',       function(d) { console.log ('disconnect') })

}

//
// magic time, courtesy of simplewebrtc
//
rtc_peer = {}

function candid_camera(url) {

    console.log('turning on cam cam : ' + url)

    // local
    if (url == '/') {

        console.log('... local')

        rtc_peer = new PeerConnection(url)

        // on connect....
        rtc_peer.onStreamAdded = function(e) {
            console.log('local on!')
            $('#local_video').append(e.mediaElement)
            $('#puck_vid_notes').append('local ')
        }

    }
    else {

        console.log('... remotely')
        var rtc_peer = new PeerConnection(url)

        rtc_peer.onStreamAdded = function(e) {
            console.log('remote on!')
            $('#local_video').html()
            $('#remote_video').append(e.mediaElement)
            $('#puck_vid_notes').append('remote ')
        }

    }

    rtc_peer.onaddstream = function (e) {

        $('#puck_vid_notes').append('addstream ')
        $('#remote_videos').append(e.video)
        $('#puck_users').append(room.roomid)

    }

    // if someone leaves, nuke vid
    rtc_peer.onuserleft = function (userid) {
        $('#puck_vid_notes').append('userleft ' + userid)
    }

//  rtc_peer.meet('puck')

}


//
// Cat chat (TM) - for moar cat fax.
//
// Cat chat guts on display
//
function cat_chat(sock, where) {

    if (typeof my_puck.ip_addr == "undefined") user = "local"
    else user = my_puck.ip_addr

    console.log('catting as : ' + user)

    // i is here
    sock.emit('new_puck', user);

    // listener, whenever the server emits 'chat_receive', this updates the chat body
    sock.on('chat_receive', function (stamp, username, data) {

        if (typeof username == "undefined") { username = '<unknown>'; }

        console.log('cat chat => ' + data)
        $('#cat_chat').prepend('<div>' + stamp + '<b>'+username + ':</b> ' + data + '<br></div>')

    });

    // click send
    $('#datasend').click( function() {
        var message = $('#meow').val();
        $('#meow').val('');
        if (message != "") {
            console.log('sending...' + message)

            // pack it off to the server... try remote first, then....
            try       { 
                remote_socket.emit('chat_send', message); 
                console.log('[remote] + ' + message)
            }
            catch (e) { 
                console.log('[local] + ' + message)
                sock.emit('chat_send', message);
            }

        }
        else {
            console.log('not sending blanx')
        }
    });

    // when hit enter
    $('#meow').keypress(function(e) {
        if(e.which == 13) {
            $(this).blur();
            console.log('hit enter')
            $('#datasend').focus().click();
            $('#meow').focus()
        }
    })

}

//
// print out an indented list from an object
//
function owalk( name, obj, str, depth ) { 
    var name  = name  || 0
    var depth = depth || 0
    var str   = str   || ''

    var index = true

    if (obj.toString() != "[object Object]") {
        index = false
    }

    str = str + '<ul css="li { margin-left:' + depth * 50 + 'px}">'
    str = str + '\n<lh><strong>' + name + '</strong>\n'

    for( var i in obj ) {
        var padding = 0
        if( typeof obj[i] === 'object' ) {
            padding = Array(depth * 4 ).join(' ')
            owalk(i, obj[i], str, ++depth)
            depth--
            str = str + '</ul>'

        } else {
            padding = Array(depth * 4 ).join(' ')
            // console.log( Array(depth * 4 ).join(' ') + i + ' : ' + obj[i] )

            if (index) 
                var s = i + ' : ' + obj[i]
            else
                var s = obj[i]

//          console.log('S: ' + index + ' ' + s)

            str = str + '\n' + padding + '<li css="li { margin-left:' + depth * 50 + 'px}">' + s + '\n'
        }
    }

    console.log(str)

    return(str)

}

// owalk("puck", x)

//
// basic puck stuff... 3 things, basics, vpn server, and vpn client stuff
//
function print_puck(ipuck, puckinfo, elements) {

    console.log('printing puck')
    console.log(ipuck)
    console.log(puckinfo)
    console.log(elements)

    var vpn = {
        port       : puckinfo.vpn.port,
        protocol   : puckinfo.vpn.protocol,
        ca         : puckinfo.vpn.ca.join('\n'),
        key        : puckinfo.vpn.key.join('\n'),
        cert       : puckinfo.vpn.cert.join('\n'),
        tlsauth    : puckinfo.vpn.tlsauth.join('\n'),
        dh         : puckinfo.vpn.dh.join('\n')
    }

    var vpn_client = {
        port       : puckinfo.vpn_client.port,
        protocol   : puckinfo.vpn_client.protocol,
        ca         : puckinfo.vpn_client.ca.join('\n'),
        key        : puckinfo.vpn_client.key.join('\n'),
        cert       : puckinfo.vpn_client.cert.join('\n')
    }

    var puck = {
        puckid     : ipuck,
        name       : name,
        owner      : puckinfo.owner.name,
        email      : puckinfo.owner.email,
        image      : puckinfo.image,
        ip         : puckinfo.ip_addr,
        vpn_ip     : puckinfo.vpn_ip,
        all_ips    : puckinfo.all_ips.join(', ')
       }

    var vpn_template = '<div><h4>VPN</h4></div>' + 
                   '<strong>port</strong>: {{port}} <br />' +
                   '<strong>protocol</strong>: {{protocol}} <br />' +
                   '<strong>ca</strong>: {{ca}} <br />' +
                   '<strong>key</strong>: {{key}} <br />' +
                   '<strong>cert</strong>: {{cert}} <br />' +
                   '<strong>tlsauth</strong>: {{tls_auth}} <br />' +
                   '<strong>DH</strong>: {{dh}} <br />'

    var vpn_client_template = '<div><h4>VPN Client</h4></div>' + 
                   '<strong>port</strong>: {{port}} <br />' +
                   '<strong>protocol</strong>: {{protocol}} <br />' +
                   '<strong>ca</strong>: {{ca}} <br />' +
                   '<strong>key</strong>: {{key}} <br />' +
                   '<strong>cert</strong>: {{cert}} <br />'

    var template = '<div><h4>ID: <span id="puckid">{{puckid}}</span></h4> <br />' +
                   '<strong>PUCK\'s name</strong>: {{user}} <br />' +
                   '<strong>Owner</strong>: {{user}} <br />' +
                   '<strong>Email</strong>: {{email}} <br />' +
                   '<strong>ip address</strong>: {{ip}} <br />' +
                   '<strong>vpn ip address</strong>: {{vpn_ip}} <br />' +
                   '<strong>all ips known</strong>: {{all_ips}} <br />' +
                   '<div style="width: 200px"><img style="max-width:100%" src="{{image}}"></div>'

    var v_html   = Mustache.to_html(vpn_template, vpn)
    var v_c_html = Mustache.to_html(vpn_client_template, vpn_client)
    var p_html   = Mustache.to_html(template, puck)

    $(elements[0]).html(p_html)
    $(elements[1]).html(v_html)
    $(elements[2]).html(v_c_html);

}

// mostly from https://www.webrtc-experiment.com/DetectRTC/
//
// can you walk and talk the ... walking talk
//
function detect_webRTC(element) {

    // ~ two per row
    $('#' + element).append('' +
                '<tr><td>Microphone    </td><td>'     + DetectRTC.hasMicrophone               + '</td>' +
                    '<td>Webcam        </td><td>'     + DetectRTC.hasWebcam                   + '</td></tr>' +
                '<tr><td>Screen Capture</td><td>'     + DetectRTC.isScreenCapturingSupported  + '</td>' +
                    '<td>WebRTC</td><td>'             + DetectRTC.isWebRTCSupported           + '</td></tr>' +
                '<tr><td>WebAudio API</td><td>'       + DetectRTC.isAudioContextSupported     + '</td>' +
                '    <td>SCTP Data Channels</td><td>' + DetectRTC.isSctpDataChannelsSupported + '</td></tr>' +
                '<tr><td>RTP Data Channels</td><td>'  + DetectRTC.isRtpDataChannelsSupported  + '</td></tr>')

}

</script>

</body>

</html>


