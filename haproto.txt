
#
# HAProxy conf for d3ck
#

global
    maxconn 99                                      # got 99 problems, but connections ain't one
    ssl-server-verify none

    daemon

    # debug

#
# seem reasonable, from various net examples
#
defaults
    timeout client      25s
    timeout connect      5s
    timeout server      25s
    timeout connect      5s
    timeout queue        5s
    timeout server      30s
    timeout tunnel       1h

    option http-keep-alive

frontend wwws
    bind :8080 ssl crt /etc/d3ck/d3cks/D3CK/d3ck.all
    timeout client 1h

    # if all else fails... web
    default_backend www_backend

    # acl is_sox path_dir usermsg

    # signals for web RTC
    acl is_sig path_dir signal
    use_backend sock_signalz if is_sig

    # normal sox stuff
    acl is_websocket hdr(Upgrade) -i WebSocket
    use_backend websocket_backend if is_websocket

    tcp-request inspect-delay 500ms
    tcp-request content accept if HTTP

#
# web
#
backend www_backend
    mode http
    option forwardfor
    reqadd x-forwarded-proto:\ https
 
    server d3ck_www D3CK_WEB:5555 weight 1 maxconn 16384 check
 
#
# web sockets
#
backend websocket_backend
    mode http
    option forwardfor
#   option http-server-close
#   option forceclose
    no option httpclose
 
    server d3ck_sox D3CK_WEB:5555 weight 1 maxconn 16384 check
 
#
# web RTC, may go local or to a remote d3ck
#
backend sock_signalz
    mode http
    option forwardfor
#   option http-server-close
#   option forceclose
    no option httpclose
 
    server d3ck_sox D3CK_SIG:5556 weight 1 maxconn 16384 check
 
